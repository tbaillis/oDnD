<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SRD Grid</title>
    <link rel="stylesheet" href="/src/game/monsters/monster-ui.css" />
    <style>
      html, body { height: 100%; margin: 0; background: #0f0f10; color: #e6e6e6; }
      .center { display: flex; height: 100%; align-items: center; justify-content: center; }
      #game-root { box-shadow: 0 0 24px rgba(0,0,0,0.6); }
      
      /* Collapsible controls styling */
      #advanced-controls {
        transition: all 0.3s ease-in-out;
        overflow: hidden;
      }
      
      #collapse-toggle {
        transition: all 0.2s ease-in-out;
      }
      
      #collapse-toggle:hover {
        background: #6b7280 !important;
        transform: translateY(-1px);
      }
      
      #collapse-icon {
        transition: transform 0.2s ease-in-out;
      }
      
      /* Pop-out controls styling */
      #controls {
        transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out !important;
      }
      
      #controls:hover {
        transform: translateX(5px) scale(1.02) !important;
        box-shadow: 0 8px 20px rgba(0,0,0,0.8) !important;
      }
      
      #controls.collapsed {
        transform: translateX(calc(-100% + 40px)) !important;
      }
      
      #controls.collapsed:hover {
        transform: translateX(0) scale(1.02) !important;
      }
      
      /* Minimize button for left-anchored controls */
      #minimize-toggle {
        position: absolute;
        right: -30px;
        top: 50%;
        transform: translateY(-50%);
        width: 25px;
        height: 60px;
        background: rgba(20,25,30,0.95);
        border: 1px solid #374151;
        border-radius: 0 6px 6px 0;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #e5e7eb;
        font-size: 14px;
        transition: all 0.2s ease-in-out;
        z-index: 1099;
      }
      
      #minimize-toggle:hover {
        background: rgba(40,45,50,0.95);
        transform: translateY(-50%) translateX(2px);
      }
      
      /* Pin button styling */
      #pin-toggle:hover {
        background: rgba(40,45,50,0.95);
        transform: translateY(0) scale(1.1);
        color: #f59e0b;
      }
      
      #pin-toggle.pinned {
        background: rgba(245,158,11,0.2) !important;
        border-color: #f59e0b !important;
        color: #f59e0b !important;
      }
      
      #pin-toggle.pinned:hover {
        background: rgba(245,158,11,0.3) !important;
      }
      
      /* Controls pinned state */
      #controls.pinned {
        border-color: #f59e0b !important;
        box-shadow: 0 4px 12px rgba(245,158,11,0.3) !important;
      }
      
      /* Token button hover effects */
      .token-btn:hover {
        opacity: 0.8 !important;
        transform: translateY(-1px);
      }
      
      #rescan-assets-btn:hover {
        background: #047857 !important;
        transform: translateY(-1px);
      }
      
      #rescan-assets-btn:disabled {
        background: #6b7280 !important;
        cursor: not-allowed !important;
        transform: none !important;
      }
      
      /* Responsive design for UI elements */
      @media (max-width: 1400px) {
        #controls { max-width: 500px !important; }
      }
      
      @media (max-width: 1200px) {
        #controls { max-width: 400px !important; font-size: 12px; }
        #controls > div > div { flex-wrap: wrap; }
      }
      
      @media (max-width: 900px) {
        #controls { 
          max-width: 320px !important; 
          font-size: 10px;
          left: 4px !important;
          top: 4px !important;
          padding: 8px 10px !important;
        }
        #controls.collapsed {
          transform: translateX(calc(-100% + 30px)) !important;
        }
        #minimize-toggle {
          width: 20px !important;
          height: 40px !important;
          right: -20px !important;
          font-size: 12px !important;
        }
        #pin-toggle {
          width: 20px !important;
          height: 20px !important;
          right: -20px !important;
          top: 50px !important;
          font-size: 10px !important;
        }
        #action-hud { 
          right: 4px !important;
          top: 4px !important;
          font-size: 11px;
          padding: 6px 8px !important;
        }
        #combat-log { 
          width: 250px !important; 
          max-height: 100px !important;
          right: 4px !important;
          bottom: 4px !important;
          top: auto !important;
          font-size: 10px;
        }
        .center { 
          padding: 0 4px;
        }
        #game-root { 
          max-width: calc(100vw - 8px);
          max-height: calc(100vh - 8px);
        }
      }
      
      /* Extra small screens - phones in portrait */
      @media (max-width: 640px) {
        #controls { 
          max-width: 280px !important; 
          font-size: 9px;
          padding: 6px 8px !important;
        }
        #controls.collapsed {
          transform: translateX(calc(-100% + 25px)) !important;
        }
        #minimize-toggle {
          width: 18px !important;
          height: 35px !important;
          right: -18px !important;
          font-size: 10px !important;
        }
        #pin-toggle {
          width: 18px !important;
          height: 18px !important;
          right: -18px !important;
          top: 45px !important;
          font-size: 9px !important;
        }
        #controls button { 
          padding: 3px 6px !important;
          font-size: 9px !important;
        }
        #controls input[type="number"] { 
          width: 40px !important;
          padding: 1px 2px !important;
          font-size: 9px !important;
        }
        #action-hud { 
          font-size: 10px;
          padding: 4px 6px !important;
          max-width: 120px;
        }
        #initiative-panel {
          font-size: 10px !important;
          padding: 4px 6px !important;
          min-width: 100px !important;
          max-width: 120px !important;
          top: 50px !important;
        }
        #combat-log { 
          width: 200px !important; 
          max-height: 80px !important;
          right: 4px !important;
          bottom: 4px !important;
          top: auto !important;
          font-size: 9px;
        }
        #monster-selection-panel {
          width: 95% !important;
          height: 85% !important;
          font-size: 12px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Centered title above the grid but behind UI controls -->
    <div id="dungeon-title" aria-hidden="true">
      <span class="dungeon-text"><em>_Dungeon</em></span>
    </div>
    <div class="center">
      <div id="game-root" aria-label="Game Canvas" role="img"></div>
    </div>
  <div id="controls" class="collapsed" style="position:fixed;top:8px;left:8px;background:rgba(20,25,30,0.95);padding:12px 16px;border-radius:8px;font-family:'Segoe UI',system-ui,Arial,sans-serif;color:#e5e7eb;border:1px solid #374151;box-shadow:0 4px 12px rgba(0,0,0,0.6);max-width:600px;z-index:1100;backdrop-filter:blur(8px);transform:translateX(0);transition:transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;">
      <!-- Minimize toggle button -->
      <div id="minimize-toggle" title="Toggle panel">‚ñ∂</div>
      <!-- Pin button -->
      <div id="pin-toggle" title="Pin panel (disable auto-collapse)" style="position:absolute;right:-30px;top:10px;width:25px;height:25px;background:rgba(20,25,30,0.95);border:1px solid #374151;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;color:#9ca3af;font-size:12px;transition:all 0.2s ease-in-out;z-index:1099;">üìå</div>
      <!-- Essential Actions (Always Visible) -->
      <div id="essential-actions" style="margin-bottom:10px;">
        <!-- Primary Buttons -->
        <div style="display:flex;gap:6px;align-items:center;margin-bottom:6px;flex-wrap:wrap;">
          <button id="new-character-btn" style="padding:6px 12px;background:#7c3aed;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:600;font-size:13px;min-width:70px;">New Character (N)</button>
          <button id="character-sheet-btn" style="padding:6px 12px;background:#059669;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:600;font-size:13px;min-width:60px;">Character (C)</button>
          <button id="spellbook-btn" style="padding:6px 12px;background:#dc2626;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:600;font-size:13px;min-width:50px;">Spells (S)</button>
          <button id="token-toggle-btn" style="padding:6px 12px;background:#f59e0b;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:600;font-size:13px;min-width:50px;">Tokens (T)</button>
          <button id="battlefield-settings-btn" style="padding:6px 12px;background:#8b5cf6;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:600;font-size:13px;min-width:65px;">‚öîÔ∏è Battlefield (B)</button>
        </div>
        
        <!-- Combat & System Actions -->
        <div style="display:flex;gap:4px;align-items:center;margin-bottom:6px;flex-wrap:wrap;">
          <button id="end-turn" style="padding:5px 10px;background:#f59e0b;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:600;font-size:12px;">End Turn</button>
          <button id="attack-mode" style="padding:5px 10px;background:#ef4444;color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px;">Attack Mode</button>
          <button id="undo-btn" style="padding:4px 8px;background:#6b7280;color:white;border:none;border-radius:3px;cursor:pointer;font-size:11px;">Undo</button>
          <button id="redo-btn" style="padding:4px 8px;background:#6b7280;color:white;border:none;border-radius:3px;cursor:pointer;font-size:11px;">Redo</button>
        </div>
        
        <!-- Collapse Toggle -->
        <div style="display:flex;align-items:center;justify-content:center;border-top:1px solid #374151;padding-top:6px;">
          <button id="collapse-toggle" style="padding:4px 12px;background:#4b5563;color:#d1d5db;border:none;border-radius:4px;cursor:pointer;font-size:12px;font-weight:500;display:flex;align-items:center;gap:4px;">
            <span id="collapse-icon">‚ñº</span>
            <span id="collapse-text">More</span>
          </button>
        </div>
      </div>

      <!-- Advanced Controls (Collapsible) -->
      <div id="advanced-controls" style="display:block;">
        <!-- Combat Options -->
        <div style="margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid #374151;">
          <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;">
            <label style="display:flex;gap:4px;align-items:center;cursor:pointer;font-size:12px;">
              <input id="avoid-toggle" type="checkbox" checked style="accent-color:#7c3aed;" />
              Safe path
            </label>
          </div>
        </div>

        <!-- Combat Toggles -->
        <div style="margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid #374151;">
          <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;font-size:12px;">
            <label style="display:flex;gap:3px;align-items:center;cursor:pointer;">
              <input id="ranged-toggle" type="checkbox" style="accent-color:#7c3aed;" /> Ranged
            </label>
            <label style="display:flex;gap:3px;align-items:center;cursor:pointer;">
              <input id="precise-toggle" type="checkbox" style="accent-color:#7c3aed;" /> Precise
            </label>
            <label style="display:flex;gap:3px;align-items:center;cursor:pointer;">
              <input id="defensive-cast-toggle" type="checkbox" style="accent-color:#7c3aed;" /> Def.Cast
            </label>
            <label style="display:flex;gap:3px;align-items:center;cursor:pointer;">
              <input id="tumble-toggle" type="checkbox" style="accent-color:#7c3aed;" /> Tumble
              <input id="tumble-bonus" type="number" value="5" style="width:40px;padding:1px 3px;border:1px solid #4b5563;border-radius:3px;background:#1f2937;color:#e5e7eb;font-size:11px;" />
            </label>
          </div>
        </div>

        <!-- Spell Casting - Compact Layout -->
        <div style="margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid #374151;">
          <div style="display:flex;gap:4px;align-items:center;flex-wrap:wrap;font-size:11px;">
            <select id="spell-select" style="padding:3px 6px;border:1px solid #4b5563;border-radius:3px;background:#1f2937;color:#e5e7eb;font-size:11px;">
              <option value="magic-missile">Magic Missile</option>
              <option value="fog-cloud">Fog Cloud</option>
            </select>
            <button id="cast-btn" style="padding:4px 8px;background:#8b5cf6;color:white;border:none;border-radius:4px;cursor:pointer;font-size:10px;">Cast</button>
            <button id="potion-btn" style="padding:4px 8px;background:#059669;color:white;border:none;border-radius:4px;cursor:pointer;font-size:10px;">Potion</button>
            <label style="display:flex;gap:3px;align-items:center;cursor:pointer;font-size:11px;">
              Conc +<input id="conc-bonus" type="number" value="5" style="width:35px;padding:1px 2px;border:1px solid #4b5563;border-radius:3px;background:#1f2937;color:#e5e7eb;font-size:10px;" />
            </label>
          </div>
        </div>

        <!-- Token Manager - Collapsible Section -->
        <div id="token-manager-section" style="margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid #374151;display:none;">
          <div id="token-manager-content" style="margin-bottom:6px;">
            <!-- Token manager content will be dynamically generated by JavaScript -->
          </div>
        </div>

        <!-- Advanced Options (Nested Collapsible) -->
        <details style="margin-bottom:6px;">
          <summary style="cursor:pointer;font-weight:600;color:#d1d5db;margin-bottom:6px;font-size:11px;">Advanced</summary>
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(80px,1fr));gap:4px;font-size:10px;color:#d1d5db;">
            <label style="display:flex;gap:2px;align-items:center;cursor:pointer;">
              <input id="terrain-toggle" type="checkbox" style="accent-color:#7c3aed;" /> Terrain
            </label>
            <label style="display:flex;gap:2px;align-items:center;cursor:pointer;">
              <input id="touch-toggle" type="checkbox" style="accent-color:#7c3aed;" /> Touch
            </label>
            <label style="display:flex;gap:2px;align-items:center;cursor:pointer;">
              <input id="flat-toggle" type="checkbox" style="accent-color:#7c3aed;" /> Flat-Ft
            </label>
            <label style="display:flex;gap:2px;align-items:center;cursor:pointer;">
              <input id="show-los-toggle" type="checkbox" style="accent-color:#7c3aed;" /> LoS
            </label>
            <label style="display:flex;gap:2px;align-items:center;cursor:pointer;">
              <input id="reachA-toggle" type="checkbox" style="accent-color:#7c3aed;" /> A:Reach
            </label>
            <label style="display:flex;gap:2px;align-items:center;cursor:pointer;">
              <input id="reachM1-toggle" type="checkbox" style="accent-color:#7c3aed;" /> M1:Reach
            </label>
            <label style="display:flex;gap:2px;align-items:center;cursor:pointer;">
              <input id="corner-cover-toggle" type="checkbox" style="accent-color:#7c3aed;" /> Corner
            </label>
            <label style="display:flex;gap:2px;align-items:center;cursor:pointer;">
              <input id="prefer-easy-toggle" type="checkbox" checked style="accent-color:#7c3aed;" /> Easy
            </label>
          </div>
        </details>

        <!-- System Controls - Compact -->
        <div style="display:flex;gap:4px;align-items:center;flex-wrap:wrap;font-size:10px;">
          <button id="ready-btn" style="padding:3px 6px;background:#6b7280;color:white;border:none;border-radius:3px;cursor:pointer;font-size:10px;">Ready</button>
          <button id="delay-btn" style="padding:3px 6px;background:#6b7280;color:white;border:none;border-radius:3px;cursor:pointer;font-size:10px;">Delay</button>
          <input id="seed-input" placeholder="Seed" style="width:50px;padding:2px 3px;border:1px solid #4b5563;border-radius:3px;background:#1f2937;color:#e5e7eb;font-size:10px;" />
          <button id="apply-seed" style="padding:3px 6px;background:#6b7280;color:white;border:none;border-radius:3px;cursor:pointer;font-size:10px;">Apply</button>
          <button id="save-btn" style="padding:3px 6px;background:#059669;color:white;border:none;border-radius:3px;cursor:pointer;font-size:10px;">Save</button>
          <button id="load-btn" style="padding:3px 6px;background:#dc2626;color:white;border:none;border-radius:3px;cursor:pointer;font-size:10px;">Load</button>
          <button id="export-btn" style="padding:3px 6px;background:#2563eb;color:white;border:none;border-radius:3px;cursor:pointer;font-size:10px;">Export</button>
          <button id="import-btn" style="padding:3px 6px;background:#10b981;color:white;border:none;border-radius:3px;cursor:pointer;font-size:10px;">Import</button>
          <input id="import-file" type="file" accept=".json,application/json" style="display:none" />
          <button id="reset-btn" style="padding:3px 6px;background:#f59e0b;color:white;border:none;border-radius:3px;cursor:pointer;font-size:10px;">Reset</button>
        </div>

        <!-- Debug Logging Settings -->
        <div style="margin-top:8px;padding-top:6px;border-top:1px solid #374151;">
          <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;font-size:11px;margin-bottom:4px;">
            <span style="color:#8b5cf6;font-weight:600;">üîç Debug Logging:</span>
          </div>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;font-size:11px;">
            <label style="display:flex;gap:3px;align-items:center;cursor:pointer;">
              <input id="ai-logging-toggle" type="checkbox" style="accent-color:#8b5cf6;" /> 
              <span style="color:#00ff00;">ü§ñ AI Calls</span>
            </label>
            <label style="display:flex;gap:3px;align-items:center;cursor:pointer;">
              <input id="detailed-logging-toggle" type="checkbox" style="accent-color:#8b5cf6;" /> 
              <span style="color:#00bfff;">üåê Server & Stack</span>
            </label>
            <label style="display:flex;gap:3px;align-items:center;cursor:pointer;">
              <input id="party-debug-toggle" type="checkbox" style="accent-color:#8b5cf6;" /> 
              <span style="color:#ffaa00;">üé≠ Party State</span>
            </label>
            <button id="show-log-panel" style="padding:3px 8px;background:#8b5cf6;color:white;border:none;border-radius:3px;cursor:pointer;font-size:10px;margin-left:8px;">Show Panel</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Action HUD -->
    <div id="action-hud" style="position:fixed;top:8px;right:8px;background:rgba(20,25,30,0.95);padding:8px 12px;border-radius:6px;font-family:'Segoe UI',system-ui,Arial,sans-serif;color:#e5e7eb;border:1px solid #374151;font-weight:600;font-size:14px;z-index:1100;box-shadow:0 4px 12px rgba(0,0,0,0.6);">
      Actions: ‚Äî
    </div>

    <!-- Initiative Order Panel -->
    <div id="initiative-panel" style="position:fixed;top:60px;right:8px;background:rgba(20,25,30,0.95);padding:8px 12px;border-radius:6px;font-family:'Segoe UI',system-ui,Arial,sans-serif;color:#e5e7eb;border:1px solid #374151;font-size:12px;z-index:1100;box-shadow:0 4px 12px rgba(0,0,0,0.6);min-width:150px;cursor:move;">
      <div id="initiative-header" style="font-weight:600;color:#f59e0b;margin-bottom:6px;text-align:center;cursor:move;user-select:none;">Initiative Order</div>
      <div id="initiative-list" style="display:flex;flex-direction:column;gap:2px;">
        <!-- Initiative list will be populated by JavaScript -->
      </div>
    </div>

    <!-- Monster Selection UI (initially hidden) -->
    <div id="monster-selection-panel" style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:90%;max-width:900px;height:80%;max-height:700px;background:rgba(20,25,30,0.95);border:2px solid #8b5cf6;border-radius:12px;z-index:2000;display:none;box-shadow:0 20px 40px rgba(0,0,0,0.8);backdrop-filter:blur(10px);">
      <!-- Monster UI content will be inserted here by the UI class -->
    </div>

  <script type="module" src="/src/main.ts"></script>
    
    <!-- Pop-out controls functionality -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const controls = document.getElementById('controls');
        const minimizeToggle = document.getElementById('minimize-toggle');
        const pinToggle = document.getElementById('pin-toggle');
        const tokenToggleBtn = document.getElementById('token-toggle-btn');
        const tokenManagerSection = document.getElementById('token-manager-section');
        
        // State variables
        let isPinned = false;
        let idleTimer;
        
        // Controls panel minimize/maximize functionality
        if (controls && minimizeToggle) {
          minimizeToggle.addEventListener('click', function() {
            controls.classList.toggle('collapsed');
            
            if (controls.classList.contains('collapsed')) {
              minimizeToggle.innerHTML = '‚óÄ';
              minimizeToggle.title = 'Expand panel';
            } else {
              minimizeToggle.innerHTML = '‚ñ∂';
              minimizeToggle.title = 'Collapse panel';
            }
          });
          
          // Pin/unpin functionality
          if (pinToggle) {
            pinToggle.addEventListener('click', function() {
              isPinned = !isPinned;
              
              if (isPinned) {
                // Pin the panel
                controls.classList.add('pinned');
                pinToggle.classList.add('pinned');
                pinToggle.title = 'Unpin panel (enable auto-collapse)';
                clearTimeout(idleTimer); // Stop auto-collapse timer
              } else {
                // Unpin the panel
                controls.classList.remove('pinned');
                pinToggle.classList.remove('pinned');
                pinToggle.title = 'Pin panel (disable auto-collapse)';
                resetIdleTimer(); // Restart auto-collapse timer
              }
            });
          }
          
          // Auto-collapse timer (only when not pinned)
          function resetIdleTimer() {
            if (isPinned) return; // Don't auto-collapse if pinned
            
            clearTimeout(idleTimer);
            idleTimer = setTimeout(() => {
              if (!controls.matches(':hover') && !isPinned) {
                controls.classList.add('collapsed');
                minimizeToggle.innerHTML = '‚óÄ';
                minimizeToggle.title = 'Expand panel';
              }
            }, 10000); // Auto-collapse after 10 seconds of inactivity
          }
          
          // Reset timer on any interaction with controls (only when not pinned)
          controls.addEventListener('mouseenter', () => {
            if (!isPinned) resetIdleTimer();
          });
          controls.addEventListener('mouseleave', () => {
            if (!isPinned) resetIdleTimer();
          });
          controls.addEventListener('click', () => {
            if (!isPinned) resetIdleTimer();
          });
          
          // Initialize timer
          resetIdleTimer();
        }

        // Token Manager toggle functionality
        if (tokenToggleBtn && tokenManagerSection) {
          let tokenManagerVisible = false;
          
          tokenToggleBtn.addEventListener('click', function() {
            tokenManagerVisible = !tokenManagerVisible;
            tokenManagerSection.style.display = tokenManagerVisible ? 'block' : 'none';
            
            // Update button appearance
            if (tokenManagerVisible) {
              this.style.background = '#dc2626'; // Red when active
              this.textContent = 'Hide Tokens (T)';
            } else {
              this.style.background = '#f59e0b'; // Orange when inactive
              this.textContent = 'Tokens (T)';
            }
          });
          
          // Token button functionality
          // Static token button handlers removed - now handled dynamically by buildCompactTokenManager()
          
          // Rescan Assets functionality is now handled by buildCompactTokenManager()
        }

        // Battlefield Settings functionality
        const battlefieldSettingsBtn = document.getElementById('battlefield-settings-btn');
        if (battlefieldSettingsBtn) {
          battlefieldSettingsBtn.addEventListener('click', function() {
            // This will be handled by the main.ts battlefieldSettings instance
            if (window.battlefieldSettings) {
              window.battlefieldSettings.showSettingsPanel();
            } else {
              console.warn('Battlefield settings not yet initialized');
            }
          });
        }

        // New Character button: open the character creation modal
        (function initNewCharacterButton() {
          const btn = document.getElementById('new-character-btn');
          if (!btn) return;
          btn.addEventListener('click', () => {
            const tryShow = (ui) => {
              if (ui && ui.characterCreation && typeof ui.characterCreation.show === 'function') {
                try { ui.characterCreation.show(); } catch (e) { console.error('Failed to show character creation modal', e); }
                return true;
              }
              return false;
            };

            const ui = window.debugUI || window.uiManager || window.characterCreationModal || null;
            if (tryShow(ui)) return;

            // Retry for a short period if UI not ready yet
            let attempts = 0;
            const t = setInterval(() => {
              attempts++;
              const ui2 = window.debugUI || window.uiManager || window.characterCreationModal || null;
              if (tryShow(ui2)) { clearInterval(t); }
              else if (attempts > 20) { clearInterval(t); console.warn('Unable to open character creation modal: UI manager not available'); }
            }, 100);
          });
        })();

        // Debug logging functionality
        const aiLoggingToggle = document.getElementById('ai-logging-toggle');
        const detailedLoggingToggle = document.getElementById('detailed-logging-toggle');
        const partyDebugToggle = document.getElementById('party-debug-toggle');
        const showLogPanelBtn = document.getElementById('show-log-panel');
        
        if (aiLoggingToggle && detailedLoggingToggle && partyDebugToggle && showLogPanelBtn) {
          // Load saved settings (but do NOT auto-apply them so the panel stays hidden on startup)
          const savedAILogging = localStorage.getItem('aiLoggingEnabled') === 'true';
          const savedDetailedLogging = localStorage.getItem('detailedLoggingEnabled') === 'true';
          const savedPartyDebug = localStorage.getItem('partyDebugEnabled') === 'true';

          // Don't check the toggles automatically on load to avoid opening the panel.
          // User must explicitly enable logging for the panel to become visible.
          aiLoggingToggle.checked = false;
          detailedLoggingToggle.checked = false;
          partyDebugToggle.checked = savedPartyDebug;

          // Wait for debug logger to be available
          function initDebugLogging() {
            if (window.debugLogger) {
              // Ensure the panel is hidden at startup regardless of saved preferences
              try { window.debugLogger.hidePanel(); } catch (e) { /* ignore */ }

              // Event listeners: when user toggles, enable logging and persist choice
              aiLoggingToggle.addEventListener('change', function() {
                const enabled = this.checked;
                window.debugLogger.enableAILogging(enabled);
                localStorage.setItem('aiLoggingEnabled', enabled.toString());
                console.log('AI Logging:', enabled ? 'enabled' : 'disabled');
              });

              detailedLoggingToggle.addEventListener('change', function() {
                const enabled = this.checked;
                window.debugLogger.enableDetailedLogging(enabled);
                localStorage.setItem('detailedLoggingEnabled', enabled.toString());
                console.log('Detailed Logging:', enabled ? 'enabled' : 'disabled');
              });

              // Party debug panel toggle
              partyDebugToggle.addEventListener('change', function() {
                const enabled = this.checked;
                localStorage.setItem('partyDebugEnabled', enabled.toString());
                
                // Find and toggle the debug panel visibility
                const debugPanels = document.querySelectorAll('[style*="position: fixed"][style*="top: 10px"][style*="right: 10px"]');
                debugPanels.forEach(panel => {
                  if (panel.innerHTML && panel.innerHTML.includes('Debug Panel')) {
                    panel.style.display = enabled ? 'block' : 'none';
                  }
                });
                
                console.log('Party Debug Panel:', enabled ? 'shown' : 'hidden');
              });

              // Show panel button should only reveal the panel (it won't enable logging automatically)
              showLogPanelBtn.addEventListener('click', function() {
                window.debugLogger.showPanel();
              });

              console.log('üîç Debug logging system initialized (panel hidden by default)');
              
              // Initialize party debug panel visibility based on saved setting
              setTimeout(() => {
                const debugPanels = document.querySelectorAll('[style*="position: fixed"][style*="top: 10px"][style*="right: 10px"]');
                debugPanels.forEach(panel => {
                  if (panel.innerHTML && panel.innerHTML.includes('Debug Panel')) {
                    panel.style.display = savedPartyDebug ? 'block' : 'none';
                  }
                });
              }, 500); // Give time for the debug panel to be created
            } else {
              // Retry in 100ms if debugLogger not available yet
              setTimeout(initDebugLogging, 100);
            }
          }

          // Initialize when ready
          initDebugLogging();
        }

        // Initiative panel dragging functionality
        const initiativePanel = document.getElementById('initiative-panel');
        const initiativeHeader = document.getElementById('initiative-header');
        
        if (initiativePanel && initiativeHeader) {
          let isDragging = false;
          let startX, startY, initialX, initialY;
          
          // Load saved position
          const savedPos = localStorage.getItem('initiativePanelPosition');
          if (savedPos) {
            const { x, y } = JSON.parse(savedPos);
            initiativePanel.style.left = x + 'px';
            initiativePanel.style.top = y + 'px';
            initiativePanel.style.right = 'auto'; // Remove right positioning
          }
          
          initiativeHeader.addEventListener('mousedown', function(e) {
            isDragging = true;
            startX = e.clientX;
            startY = e.clientY;
            
            const rect = initiativePanel.getBoundingClientRect();
            initialX = rect.left;
            initialY = rect.top;
            
            // Remove right positioning to use left/top instead
            initiativePanel.style.right = 'auto';
            initiativePanel.style.left = initialX + 'px';
            initiativePanel.style.top = initialY + 'px';
            
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
            
            e.preventDefault();
          });
          
          function onMouseMove(e) {
            if (!isDragging) return;
            
            const dx = e.clientX - startX;
            const dy = e.clientY - startY;
            
            const newX = Math.max(0, Math.min(window.innerWidth - initiativePanel.offsetWidth, initialX + dx));
            const newY = Math.max(0, Math.min(window.innerHeight - initiativePanel.offsetHeight, initialY + dy));
            
            initiativePanel.style.left = newX + 'px';
            initiativePanel.style.top = newY + 'px';
          }
          
          function onMouseUp(e) {
            if (isDragging) {
              isDragging = false;
              
              // Save position
              const rect = initiativePanel.getBoundingClientRect();
              localStorage.setItem('initiativePanelPosition', JSON.stringify({
                x: rect.left,
                y: rect.top
              }));
              
              document.removeEventListener('mousemove', onMouseMove);
              document.removeEventListener('mouseup', onMouseUp);
            }
          }
        }

        // Global keyboard shortcuts
        document.addEventListener('keydown', function(e) {
          // Only handle if not in an input field
          if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
          
          if (e.key === 't' || e.key === 'T') {
            if (tokenToggleBtn) {
              tokenToggleBtn.click();
            }
          }
          if (e.key === 'b' || e.key === 'B') {
            const battlefieldBtn = document.getElementById('battlefield-settings-btn');
            if (battlefieldBtn) {
              battlefieldBtn.click();
            }
          }
        });
      });
    </script>
  </body>
</html>
